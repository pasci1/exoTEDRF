<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NIRISS/SOSS Reduction &mdash; exoTEDRF 2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=bbec6902"></script>
        <script src="../../_static/documentation_options.js?v=6fefd858"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Light Curve Fitting with exoTEDRF" href="tutorial_light-curve-fitting.html" />
    <link rel="prev" title="exoTEDRF Usage Guide" href="../usage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            exoTEDRF
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../usage.html">exoTEDRF Usage Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../usage.html#tutorial-notebooks">Tutorial Notebooks</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">NIRISS/SOSS Reduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Stage-1-–-Detector-Level-Processing">Stage 1 – Detector-Level Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Stage-2-–-Spectroscopic-Processing">Stage 2 – Spectroscopic Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Stage-3-–-1D-Spectral-Extraction">Stage 3 – 1D Spectral Extraction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_light-curve-fitting.html">Light Curve Fitting with exoTEDRF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../usage.html#scripting">Scripting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../citations.html">Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">exoTEDRF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../usage.html">exoTEDRF Usage Guide</a></li>
      <li class="breadcrumb-item active">NIRISS/SOSS Reduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/content/notebooks/tutorial_niriss-soss.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://github.com/radicamc/exoTEDRF/tree/main/docs/content/notebooks/tutorial_niriss-soss.ipynb">Download full notebook here</a></p>
</div>
<section id="NIRISS/SOSS-Reduction">
<h1>NIRISS/SOSS Reduction<a class="headerlink" href="#NIRISS/SOSS-Reduction" title="Link to this heading"></a></h1>
<p>This notebook will walk you through the basics of data analysis for NIRISS/SOSS.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First thing to do is set your CRDS variables so we can download the most up-to-date JWST</span>
<span class="c1"># reference files.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">Now let’s get some data! exoTEDRF has a useful functionality which allows you to automatically grab any (public) data from the MAST archive.</div>
<div class="line">Let’s use the WASP-39b transit observations from the JWST Transiting Exoplanet Community Early Release Science program published in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023Natur.614..670F/abstract">Feinstein &amp; Radica et al. (2023)</a>.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exotedrf.extra_functions</span> <span class="kn">import</span> <span class="n">download_observations</span>

<span class="c1"># We want all data associated with proposal ID 1366 for target WASP-39b. Additionally we</span>
<span class="c1"># specify NIRISS/SOSS since this program also observed the same planet with NIRSpec and NIRCam.</span>
<span class="c1"># Lastly, we want both the usual CLEAR observations as well as those using the F277W filter,</span>
<span class="c1"># which restricts the SOSS wavelength range to &gt;2.5µm.</span>

<span class="n">download_observations</span><span class="p">(</span><span class="n">proposal_id</span><span class="o">=</span><span class="s1">&#39;1366&#39;</span><span class="p">,</span> <span class="n">objectname</span><span class="o">=</span><span class="s1">&#39;WASP-39b&#39;</span><span class="p">,</span> <span class="n">instrument_name</span><span class="o">=</span><span class="s1">&#39;NIRISS/SOSS&#39;</span><span class="p">,</span>
                      <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CLEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;F277W&#39;</span><span class="p">])</span>

<span class="c1"># This will store all files in a folder in the present directory called DMS_uncal.</span>
</pre></div>
</div>
</div>
<p>Now let’s create output directories to store our data products.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exotedrf</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="c1"># Generate output directories</span>
<span class="n">utils</span><span class="o">.</span><span class="n">verify_path</span><span class="p">(</span><span class="s1">&#39;pipeline_outputs_directory&#39;</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">verify_path</span><span class="p">(</span><span class="s1">&#39;pipeline_outputs_directory/Stage1&#39;</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">verify_path</span><span class="p">(</span><span class="s1">&#39;pipeline_outputs_directory/Stage2&#39;</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">verify_path</span><span class="p">(</span><span class="s1">&#39;pipeline_outputs_directory/Stage3&#39;</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">verify_path</span><span class="p">(</span><span class="s1">&#39;pipeline_outputs_directory/Stage4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">exoTEDRF is subdivided into four stages, mirroring the STScI jwst pipeline.</div>
<div class="line">The stages are as follows: - Stage 1: Detector Level Processing - Stage 2: Spectroscopic Processing - Stage 3: 1D Spectral Extraction - Stage 4: Light Curve Fitting</div>
</div>
<p>This notebook will walk you through stages 1 to 3, or from raw data to extracted stellar spectra, mostly following the steps laid out in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023MNRAS.524..835R/abstract">Radica et al. (2023)</a>.</p>
<section id="Stage-1-–-Detector-Level-Processing">
<h2>Stage 1 – Detector-Level Processing<a class="headerlink" href="#Stage-1-–-Detector-Level-Processing" title="Link to this heading"></a></h2>
<p>Stage 1 performs multiple important calibrations on the raw, 4D (integrations, groups, y-pixel, x-pixel) data cubes. Several steps are simply wrappers around the existing functionalities of the STScI pipeline, whose documentation can be found <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_detector1.html">here</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exotedrf</span> <span class="kn">import</span> <span class="n">stage1</span>

<span class="c1"># First define some input and output directory paths.</span>

<span class="n">uncal_indir</span> <span class="o">=</span> <span class="s1">&#39;DMS_uncal/&#39;</span>  <span class="c1"># Where our uncalibrated files are found.</span>
<span class="n">outdir_s1</span> <span class="o">=</span> <span class="s1">&#39;pipeline_outputs_directory/Stage1/&#39;</span>  <span class="c1"># Where to save our Stage 1 output files.</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">Now let’s make a list with all the uncal input files. Here we’re only concerned with the CLEAR exposure files, and not the F277W filter ones.</div>
<div class="line">In this case, the full TSO is broken up into four segments.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">uncal_indir</span><span class="o">+</span><span class="s1">&#39;jw01366001001_04101_00001-seg001_nis_uncal.fits&#39;</span><span class="p">,</span>
             <span class="n">uncal_indir</span><span class="o">+</span><span class="s1">&#39;jw01366001001_04101_00001-seg002_nis_uncal.fits&#39;</span><span class="p">,</span>
             <span class="n">uncal_indir</span><span class="o">+</span><span class="s1">&#39;jw01366001001_04101_00001-seg003_nis_uncal.fits&#39;</span><span class="p">,</span>
             <span class="n">uncal_indir</span><span class="o">+</span><span class="s1">&#39;jw01366001001_04101_00001-seg004_nis_uncal.fits&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Let’s check the readout pattern of the observations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. integrations: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NINTS&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. groups: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NGROUPS&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;subarray: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SUBARRAY&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No. integrations: 537
No. groups: 9
subarray: SUBSTRIP256
</pre></div></div>
</div>
<p>Here we can see that the full TSO consists of 537 integrations, with 9 groups per integration using the 256x2048 pixel subarray, which provides the full 0.6 – 2.8µm wavelength range.</p>
<p>Let’s now take a look at what the raw data looks like.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># Let&#39;s check out the last group of the 10th integration</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
               <span class="n">vmin</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3e4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_16_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_16_0.png" />
</div>
</div>
<p>We can clearly see the first (lower) and second (upper) orders of the target spectrum, as well as a number of nasty detector effects!</p>
<p>We’re now ready to start with the actual reduction.</p>
<section id="DQ-Initalization-Step">
<h3>DQ Initalization Step<a class="headerlink" href="#DQ-Initalization-Step" title="Link to this heading"></a></h3>
<p>Intializes the data quality flags.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the step by passing the input files and the directory to which we want to save</span>
<span class="c1"># the outputs.</span>
<span class="c1"># There&#39;s also an option to pass an existing deepstack of this TSO in order to identify and flag</span>
<span class="c1"># hot pixels which may not be in the default DQ maps.</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">DQInitStep</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">deepframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="c1"># Now run the step!</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Saturation-Detection-Step">
<h3>Saturation Detection Step<a class="headerlink" href="#Saturation-Detection-Step" title="Link to this heading"></a></h3>
<p>Flags any saturated pixels in the observations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This time we pass the outputs from the previous step as the inputs for this step.</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">SaturationStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Superbias-Subtraction-Step">
<h3>Superbias Subtraction Step<a class="headerlink" href="#Superbias-Subtraction-Step" title="Link to this heading"></a></h3>
<p>Now we subtract the superbias level from all frames.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">SuperBiasStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="c1"># This step has options for diagnostic plotting. Specifying do_plot=True will create the step</span>
<span class="c1"># plot and save it to the output directory.</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the step plot.</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;superbiasstep.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_24_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_24_0.png" />
</div>
</div>
<p>Nine random frames are shown in the diagnostic plot, where we can verify that many of the detector effects we saw above, including the bright clouds at the bottom of the frame are now gone.</p>
</section>
<section id="Reference-Pixel-Correction-Step">
<h3>Reference Pixel Correction Step<a class="headerlink" href="#Reference-Pixel-Correction-Step" title="Link to this heading"></a></h3>
<p>This is a wrapper around an existing STScI pipeline step, whose main purpose was to correct time-correlated 1/f noise by using reference pixels. However, SOSS only has four rows of reference pixels at the top of the frame, and so this step actually does not do a very good job of correcting the 1/f noise! However, it is useful to remove integration-to-integration bias variations as well as odd-even row effects.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">RefPixStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Dark-Current-Subtraction-Step">
<h3>Dark Current Subtraction Step<a class="headerlink" href="#Dark-Current-Subtraction-Step" title="Link to this heading"></a></h3>
<p>Another wrapper around an STScI pipeline step. This one is optional, and many analyses skip it as the existing dark current reference files show clear residual 1/f noise. Moreover, particularly for NIR observations, the actual dark current signal is extremely small. However, I include it here for completeness!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">DarkCurrentStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="1/f-Noise-Correction-Step">
<h3>1/f Noise Correction Step<a class="headerlink" href="#1/f-Noise-Correction-Step" title="Link to this heading"></a></h3>
<p>1/f noise is time-correlated noise which manifests in SOSS observations as column-correlated “stripes”. The 1/f noise is actually caused by time-varying voltage levels as the detector is read, and as such it is actually one of the very last noise sources (along with read noise) to be injected into the data. exoTEDRF, therefore, corrects 1/f noise at the group-level (i.e., before ramp fitting) as is done with the other JWST instrument modes.</p>
<p>1/f noise correction can also be done at the integration-level (i.e., after ramp fitting) in addition to, or instead of the group-level correction is your wish. In which case, feel free to skip this step!</p>
<section id="First-Background-Subtraction">
<h4>First Background Subtraction<a class="headerlink" href="#First-Background-Subtraction" title="Link to this heading"></a></h4>
<p>For reasons outlined more completely in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023Natur.614..670F/abstract">Feinstein &amp; Radica et al. (2023)</a> and <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023MNRAS.524..835R/abstract">Radica et al. (2023)</a>, the SOSS background signal <strong>must</strong> be subtract before attempting the 1/f noise correction. Here, we do a group-level background subtraction — that is we subtract a background signal separately from each group.</p>
<p>Technically the background signal needs to be corrected for flat field, and linearity effects (amongst other things) which we have not yet done. We’ll therefore be adding the background signal back to the data after the 1/f noise correction.</p>
<p>The SOSS background has a unique structure caused by the undispersed light from the zodiacal background falling off the JWST pick-off mirror. STScI has created a model of the SOSS background which can be found <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-imager-and-slitless-spectrograph/niriss-observing-strategies/niriss-soss-recommended-strategies">here</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open the STScI background model.</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">background_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;model_background256.npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s see what the background model looks like.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">background_model</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_34_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_34_0.png" />
</div>
</div>
<p>There’s clearly a sharp increase in the background level at pixel ~700 caused by the zodi order 0 suddenly falling off the pick-off mirror. The background level slowly decreases towards the right.</p>
<p>Let’s now subtract the SOSS background.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The background correction step technically lives within Stage 2 of exoTEDRF.</span>

<span class="kn">from</span> <span class="nn">exotedrf</span> <span class="kn">import</span> <span class="n">stage2</span>

<span class="c1"># In addition to the input files and output directory, we also want to pass the bacground model</span>
<span class="c1"># that we opened above, as well as an estimate of the integrations which define the transit</span>
<span class="c1"># baseline; in this case the first 150 and last 100 are reasonable.</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">BackgroundStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">background_model</span><span class="o">=</span><span class="n">background_model</span><span class="p">,</span>
                             <span class="n">baseline_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="c1"># Specifying differential=True allows for the background model to be scaled seperately to the</span>
<span class="c1"># right and left of the &quot;step&quot; at pixel ~700 (recommended).</span>

<span class="n">results</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">differential</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This step will produce two diagnostic plots. The first, once again, shows nine random frames, but now with the background subtracted. The increase in brightness at column ~700 that we saw after the superbias subtraction has nicely been removed. In some cases (like here), we can even see evidence for the 1/f striping!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;backgroundstep_1.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_39_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_39_0.png" />
</div>
</div>
<p>The second plot shows a cut along a detector row at the top of the detector to better visualize the background removal.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;backgroundstep_2.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_41_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_41_0.png" />
</div>
</div>
</section>
<section id="1/f-Noise-Correction">
<h4>1/f Noise Correction<a class="headerlink" href="#1/f-Noise-Correction" title="Link to this heading"></a></h4>
<p>We can now proceed with the correction of the 1/f noise itself.</p>
<p>exoTEDRF provides four different methods for 1/f correction, but we’ll proceed with the simplest one, “scale-achromatic”, here. It simply consists of constructing difference images by subtracting a median stack from each individual frame, and subtracting the median value from each column.</p>
<div class="line-block">
<div class="line">It’s a good idea to disclude any bad pixels, or pixels which are affected by field stars from the calculation so that we don’t bias the 1/f value calculated for a given column. To address this, there is an optional <code class="docutils literal notranslate"><span class="pre">pixel_masks</span></code> keyword to which can be passed masks of pixels to exclude in each frame.</div>
<div class="line">If no such masks are available, the step will automatically mask all pixels with non-zero DQ flags, as well as obvious outliers.</div>
</div>
<p>exoTEDRF produces pixel masks for this specific purpose during the RampFitStep in Stage 1 and TracingStep in Stage 2, so it is always a good idea to do a first quick run through of the pipeline to get a feel for the data, and create these useful auxiliary files. Then do a second “good” reduction using the outputs from the first pass.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pixel_masks</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># If available, the exoTEDRF pixel masks will have the filenames XXX_pixelflags.fits and there</span>
<span class="c1"># will always be one for each segment.</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">For the scale-achromatic method, it is also a good idea to pass an estimate of the planet’s white light curve. This is so that the median stack can be scaled to the average flux level of each frame before being subtracted.</div>
<div class="line">Again, if no such estimate is available, the light curve will be estimated from the current data. A light curve estimate .npy file is also created during the TracingStep.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># If available, the exoTEDRF timeseries estimate file will have the name XXX_lcestimate.npy.</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the step passing the input files as well as any auxiliary files mentioned above.</span>
<span class="c1"># Moreover, we also want to indicate the indices of the baseline integrations and the 1/f</span>
<span class="c1"># correction method that we wish to use.</span>
<span class="c1"># Lastly, we also pass the background model from the BackgroundStep so that it can be re-added.</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">OneOverFStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">baseline_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">,</span>
                           <span class="n">pixel_masks</span><span class="o">=</span><span class="n">pixel_masks</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="n">timeseries</span><span class="p">,</span>
                           <span class="n">method</span><span class="o">=</span><span class="s1">&#39;scale-achromatic&#39;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">bkg</span><span class="p">)</span>

<span class="c1"># even_odd_rows=True calculates seperate 1/f noise values for even- and odd-values rows. This</span>
<span class="c1"># if likely taken care of adequately by the RefPixStep above, but it can&#39;t hurt to do it again!</span>
<span class="c1"># inner_mask_width=40 defines the width of pixels around the target spectral trace to mask. It&#39;s</span>
<span class="c1"># a good idea to make this at least as large as your planned extraction aperture.</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">even_odd_rows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">inner_mask_width</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>At least two diagnostic plots are produced here (depending on the method). The first will always be our familiar nine-panel plot, now showing difference images after the 1/f noise correction. We don’t want to see any column-correlated noise left here!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;oneoverfstep_1.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_49_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_49_0.png" />
</div>
</div>
<p>The second is a power series of the data before and after the 1/f correction. The power spectral density before the correction clearly increases, roughly linearly, towards shorter frequencies (hence 1/f!). After the correction though, we can see that the psd is much flatter. We have done a pretty good job of removing all the 1/f noise!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;oneoverfstep_2.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_51_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_51_0.png" />
</div>
</div>
<div class="alert alert-block alert-info"><p>NOTE: If running the OneOverFStep at the integration level, don’t pass anything to the background keyword so that the background is not unnecessarily re-added to the data.</p>
</div></section>
</section>
<section id="Linearity-Step">
<h3>Linearity Step<a class="headerlink" href="#Linearity-Step" title="Link to this heading"></a></h3>
<p>The HgCdTe detectors used in NIRISS are not perfectly linear, which means that as saturation is approached, the counts begin to plateau and less flux is recorded than is actually observed. This is not an issue just with NIRISS, but all other JWST instruments as well. This step applies pre-calcuated polynomials to correct these non-linearity effects in the ramp.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">LinearityStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The first diagnostic plot shows (mean-subtracted) group-to-group differences. For a perfect non-linearity correction, we would expect each difference to be identical. The correction is therefore not perfect, but it’s much better than where we started!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;linearitystep_1.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_56_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_56_0.png" />
</div>
</div>
<p>The second plot shows the residuals to a perfectly straight ramp before and after correction. before the correction, we see large positive residuals at intermediate group numbers, indicating that the ramp is indeed plateauing. We’re much better, but again not perfect, after the correction.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;linearitystep_2.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_58_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_58_0.png" />
</div>
</div>
</section>
<section id="Jump-Detection-Step">
<h3>Jump Detection Step<a class="headerlink" href="#Jump-Detection-Step" title="Link to this heading"></a></h3>
<p>We now want to detect and flag cosmic ray hits in the data. There are two main ways to do this: up-the-ramp or time-domain flagging.</p>
<p>The up-the-ramp flagging algorithm is the default algorithm in the STScI pipeline. In entails identifying discontinuities above a certain threshold in ramps, and flagging these as jumps. Unfortunately, this method can be quite temperamental and has been found by many studies to flag random noise. It also cannot be applied to ngroup=2 datasets (which are reasonably common with NIRISS/SOSS!)</p>
<p>The time-domain flagging method uses a sigma clipping algorithm to identify cosmic ray hits in the time domain. This method also has the benefit of working for observations with any number of groups.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">JumpStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="c1"># Here we will use the time-domain rejection by specifying flag_in_time=True, and use a clipping</span>
<span class="c1"># threshold of 7 sigma.</span>
<span class="c1"># In order to use the up-the-ramp flagging, specify instead flag_up_ramp=True and pass an</span>
<span class="c1"># appropriate value to the rejection_threshold keyword.</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flag_in_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">time_rejection_threshold</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The diagnostic plot here shows the locations of flagged jumps, as well as hot pixels in nine frames.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;jump.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_62_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_62_0.png" />
</div>
</div>
</section>
<section id="Ramp-Fit-Step">
<h3>Ramp Fit Step<a class="headerlink" href="#Ramp-Fit-Step" title="Link to this heading"></a></h3>
<p>Now that all the initial detector-level calibrations are done, we are ready for ramp fitting! This step is a wrapper around the STScI pipeline step that fits a slope and intercept as a function of group to each pixel. We don’t use the intercept values, and only care about the slopes moving forwards.</p>
<p>This step also produces outlier pixel masks by combining all existing data flags. One flag file is produced for each segment and is saved in the Stage 1 directory with the name XXX_pixelflags.fits.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">RampFitStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Gain-Scale-Step">
<h3>Gain Scale Step<a class="headerlink" href="#Gain-Scale-Step" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">The gain scale correction does the conversion from DN/s to e-/s by multiplying the data values by the wavelength dependent SOSS gain (1.6 e-/DN on average).</div>
<div class="line">Currently, though, this correction does nothing! But maybe it won’t sometime soon!</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage1</span><span class="o">.</span><span class="n">GainScaleStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We are now ready to start with Stage 2!</p>
</section>
</section>
<section id="Stage-2-–-Spectroscopic-Processing">
<h2>Stage 2 – Spectroscopic Processing<a class="headerlink" href="#Stage-2-–-Spectroscopic-Processing" title="Link to this heading"></a></h2>
<p>This stage performs some additional calibrations on the, now 3D (integrations, y-pixel, x-pixel), data after the ramp fitting to make the data ready for the spectral extraction. Once again, information on the default STScI pipeline steps can be found <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec2.html">here</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exotedrf</span> <span class="kn">import</span> <span class="n">stage2</span>

<span class="c1"># Let&#39;s now save outputs to the Stage 2 subdirectory.</span>

<span class="n">outdir_s2</span> <span class="o">=</span> <span class="s1">&#39;pipeline_outputs_directory/Stage2/&#39;</span>
</pre></div>
</div>
</div>
<section id="Assign-WCS-Step">
<h3>Assign WCS Step<a class="headerlink" href="#Assign-WCS-Step" title="Link to this heading"></a></h3>
<p>This is a wrapper around the STScI pipeline step which assigns the appropriate WCS to the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">AssignWCSStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s2</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Source-Type-Determination-Step">
<h3>Source Type Determination Step<a class="headerlink" href="#Source-Type-Determination-Step" title="Link to this heading"></a></h3>
<p>For multiple subsequent steps to function, we need to correctly identify the source type in our observations. For all exoplanet TSOs, the correct type is a point source.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">SourceTypeStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s2</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Flat-Field-Subtraction-Step">
<h3>Flat Field Subtraction Step<a class="headerlink" href="#Flat-Field-Subtraction-Step" title="Link to this heading"></a></h3>
<p>This step corrects flat fielding effects.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">FlatFieldStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s2</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Background-Subtraction-Step">
<h3>Background Subtraction Step<a class="headerlink" href="#Background-Subtraction-Step" title="Link to this heading"></a></h3>
<p>It’s now time to subtract the background once and for all! (Or for the first time if you skipped the group-level 1/f noise correction). Now that the background flux has been flat fielded and correted for non-linearty effects, it can be safely removed.</p>
<p>We’re going to run the same step as we did previously in Stage 1, but this time on the slope images. This means we’re only getting one background image as opposed to one for each group.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reuse the same background model from the group-level correction</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">BackgroundStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">background_model</span><span class="o">=</span><span class="n">background_model</span><span class="p">,</span>
                             <span class="n">baseline_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s2</span><span class="p">)</span>

<span class="c1"># Using all the same parameters from the group-level background subtraction again here,</span>
<span class="c1"># including the differential scaling.</span>
<span class="c1"># We don&#39;t need to re-add the background to the data later, so we only need to return the</span>
<span class="c1"># corrected data.</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">differential</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s2</span> <span class="o">+</span> <span class="s1">&#39;backgroundstep_1.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_78_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_78_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s2</span> <span class="o">+</span> <span class="s1">&#39;backgroundstep_2.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_79_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_79_0.png" />
</div>
</div>
<div class="alert alert-block alert-info"><p>NOTE: If doing the OneOverFStep at the integration level, this is where the step should be run.</p>
</div></section>
<section id="Bad-Pixel-Correction-Step">
<h3>Bad Pixel Correction Step<a class="headerlink" href="#Bad-Pixel-Correction-Step" title="Link to this heading"></a></h3>
<p>The penultimate step in Stage 2 is the final step which actually performs any data calibration. We are now going to interpolate any remaining bad pixels in the data to be ready for the spectral extraction.</p>
<p>The BadPixStep performs two iterations of bad pixel detection and correction: the first is a spatial correction, and the second a temporal one.</p>
<p>The spatial correction uses a median stack of all integrations to identify any pixels which are systematic outliers across the entire time series. These pixels are flagged, and then interpolate using a median of the surrounding pixels in each integration. Any pixels with DQ flags are also interpolated in this way.</p>
<p>The temporal flagging works the same way as the time-domain jump detection, by flagging any pixels which are outliers along the time axis, and replacing them with a median of the surrounding pixels in time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">BadPixStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">baseline_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s2</span><span class="p">)</span>

<span class="c1"># We&#39;re going to use a 10 sigma threshold for both the spatial and temporal corrections.</span>

<span class="n">results</span><span class="p">,</span> <span class="n">deepframe</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">space_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">time_thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s2</span> <span class="o">+</span> <span class="s1">&#39;badpixstep.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_83_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_83_0.png" />
</div>
</div>
<p>The diagnostic plot here shows the deep stack (median stack) with the locations of all hot and other flagged pixels.</p>
</section>
<section id="Tracing-Step">
<h3>Tracing Step<a class="headerlink" href="#Tracing-Step" title="Link to this heading"></a></h3>
<p>This step does not do any actual data calibration, but produces a number of auxiliarly files which may be useful either for improving the reduction, or in the subsequent light curve analysis.</p>
<div class="line-block">
<div class="line">It has four major functionalities:</div>
<div class="line">1. Locate the centroids of all three SOSS orders via the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2022PASP..134j4502R/abstract">edgetrigger algorithm</a>.</div>
<div class="line">2. (optional) Generate a mask of order 0 contaminants from background stars.</div>
<div class="line">3. (optional) Calculate the stability of the SOSS traces over the course of the TSO.</div>
<div class="line">4. (optional) Create a smoothed estimate of the order 1 white light curve.</div>
</div>
<p>The positions of the target traces are necessary for the spectral extraction, and this is the only functionality that happens by default.</p>
<p>The first optional functionality is to add the positions of order 0 contaminants to the pixel masks created above. Since SOSS is slitless, background stars can contaminate the frame, and potentially bias the 1/f noise estimation. Using an F277W exposure, the TracingStep automatically detects the locations of these contaminants and adds them to the pixel masks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># File names of pixel masks produced by the RampFitStep.</span>

<span class="n">pixel_masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;jw01366001001_04101_00001-seg001_nis_pixelflags.fits&#39;</span><span class="p">,</span>
               <span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;jw01366001001_04101_00001-seg002_nis_pixelflags.fits&#39;</span><span class="p">,</span>
               <span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;jw01366001001_04101_00001-seg003_nis_pixelflags.fits&#39;</span><span class="p">,</span>
               <span class="n">outdir_s1</span> <span class="o">+</span> <span class="s1">&#39;jw01366001001_04101_00001-seg004_nis_pixelflags.fits&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We also need an F277W exposure for this to work. This is why we downloaded the F277W exposure data in the first place!</p>
<p>That F277W exposure was obviously just the raw data, but it can be calibrated in much the same way as the CLEAR data that we have been working with. In fact, the only essential steps are the DQInitStep, SuperBiasStep, and RampFitStep. A simple removal of 1/f noise via subtracting a column-wise median and then averaging over all integrations is good enough to make the final frame that we need here. In fact, a “calibrated” version of the WASP-39b F277W exposure is available
<a class="reference external" href="https://github.com/radicamc/exoTEDRF/tree/main/docs/content/data">here</a>.</p>
<p>Let’s open the F277W exposure and see what it looks like.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open the F277W exposure.</span>

<span class="n">f277w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;../data/F277W.npy&#39;</span><span class="p">)</span>

<span class="c1"># Now let&#39;s display it!</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">f277w</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_88_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_88_0.png" />
</div>
</div>
<p>Only the reddest end of the target order 1 spectral trace is transmitted by the F277W filter, and so all of the background star contaminants are revealed! Every splotch above is the undispersed 0th order of a background star which was within the field of view of the target during the observation. This is why it’s a good idea to judiciously choose your appropriate APAs when planning NIRISS/SOSS observations!</p>
<p>It’s even possible to have dispersed contaminats present on the detector, and there is actually a very faint one in this dataset! But these most likely won’t show up in the F277W exposure.</p>
<p>The second optional functionality uses a principal component analysis to assess the stability of the SOSS trace over the course of the TSO (see <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023Natur.620..292C/abstract">Coulombe et al. (2023)</a> for more details). These eigenvalues may be incredibly useful for light curve detrending.</p>
<p>The final optional functionality is to create an estimate of the order 1 white light curve. Of course, you can simply do this yourself after the spectral extraction!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="n">stage2</span><span class="o">.</span><span class="n">TracingStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">deepframe</span><span class="o">=</span><span class="n">deepframe</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s2</span><span class="p">)</span>

<span class="c1"># Specify generate_order0_mask=True and pass the f277w exposure as well as the pixel masks to</span>
<span class="c1"># add the positions of contaminats to the pixel masks.</span>
<span class="c1"># Pass calculate_stability=True to do the principal component analysis.</span>
<span class="c1"># generate_lc=True will produce the order 1 white light curve estimate.</span>

<span class="n">step_results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">pixel_flags</span><span class="o">=</span><span class="n">pixel_masks</span><span class="p">,</span> <span class="n">generate_order0_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">f277w</span><span class="o">=</span><span class="n">f277w</span><span class="p">,</span>
                        <span class="n">calculate_stability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">generate_lc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">baseline_ints</span><span class="o">=</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">],</span> <span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">centroids</span> <span class="o">=</span> <span class="n">step_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outdir_s2</span> <span class="o">+</span> <span class="s1">&#39;soss_stability_pca.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_92_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_92_0.png" />
</div>
</div>
<p>The diagnostic plot here shows the first 10 PCs derived from this dataset. In general, only the first handful have any useful information. The first PC is almost always the transit (or eclipse) light curve. The PCA will also pick up any drifts in the position of the trace (2nd and 3rd components here), as well as the characteristic beating pattern that is ubiquitous in all SOSS observations (4th component) and has to do with the thermal cycling of the telescope’s instruments. The PCA can also
easily pick out mirror tilt events if any are present in the observations.</p>
<p>Now one more thing before moving on to the extraction. Let’s take a look at the deep stack and double check our trace positions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in the trace positions.</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">centroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">outdir_s2</span> <span class="o">+</span> <span class="s1">&#39;jw01366001001_04101_00001_nis_centroids.csv&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the deepframe and the trace positions.</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">deepframe</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Show a width of 30 pixels around the trace.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;xpos&#39;</span><span class="p">],</span> <span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;ypos o1&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Order 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;xpos&#39;</span><span class="p">],</span> <span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;ypos o1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;xpos&#39;</span><span class="p">],</span> <span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;ypos o2&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Order 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;xpos&#39;</span><span class="p">],</span> <span class="n">centroids</span><span class="p">[</span><span class="s1">&#39;ypos o2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_96_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_96_0.png" />
</div>
</div>
<p>Everything looks good! We’re now ready for Stage 3 and the spectral extraction.</p>
</section>
</section>
<section id="Stage-3-–-1D-Spectral-Extraction">
<h2>Stage 3 – 1D Spectral Extraction<a class="headerlink" href="#Stage-3-–-1D-Spectral-Extraction" title="Link to this heading"></a></h2>
<p>This is the shortest stage, as it just performs the 1D spectral extraction.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exotedrf</span> <span class="kn">import</span> <span class="n">stage3</span>

<span class="c1"># Let&#39;s now save outputs to the Stage 3 subdirectory.</span>

<span class="n">outdir_s3</span> <span class="o">=</span> <span class="s1">&#39;pipeline_outputs_directory/Stage3/&#39;</span>
</pre></div>
</div>
</div>
<p>There are two methods that one can use for the spectral extraction: a simple box aperture extraction or the ATOCA algorithm. The box aperture extraction is the easiest, simply place an aperture around the target trace and sum up the flux!</p>
<p>Now, you probably noticed that the order 1 and order 2 traces partially overlap in the deep stakc image we made above. So a simple box aperture extraction will have some degree of self-contamination! It turns out for <em>relative measurements</em>, like transit observations, this effect is neglible for the vast majority of targets, so a box extraction is probably a safe bet. However, the ATOCA algorithm was developed to explicitly model and correct the SOSS self-contamination. If you’re interested, the
algorithm is detailed in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2022PASP..134i4502D/abstract">Darveau-Bernier et al. (2022)</a> and <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2022PASP..134j4502R/abstract">Radica et al. (2022)</a>.</p>
<p>In this case, we’re simply going to go with the box aperture extraction for convenience.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;re passing the parameters of the WASP-39 host star in order to cross correlate the</span>
<span class="c1"># extracted stellar spectrum with a PHOENIX model and improve the extracted wavelength</span>
<span class="c1"># solution.</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">stage3</span><span class="o">.</span><span class="n">Extract1DStep</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">extract_method</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">outdir_s3</span><span class="p">,</span>
                            <span class="n">st_teff</span><span class="o">=</span><span class="mi">5485</span><span class="p">,</span> <span class="n">st_logg</span><span class="o">=</span><span class="mf">4.453</span><span class="p">,</span> <span class="n">st_met</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># Here, we&#39;re using an aperture width of 30 pixels.</span>
<span class="c1"># We also pass the trace positions from above.</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">soss_width</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">centroids</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><em>Tada!</em> You now have stellar spectra of WASP-39! Let’s take a quick look at the wavelength-dependent light curves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open the extracted spectrum file and get the relevant quantities.</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outdir_s3</span> <span class="o">+</span> <span class="s1">&#39;WASP-39_box_spectra_fullres.fits&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">spec</span><span class="p">:</span>

    <span class="n">wave1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Order 1 wavelengths</span>
    <span class="n">wave2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">spec</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Order 2 wavelengths</span>

    <span class="n">order1</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># Order 1 spectra</span>
    <span class="n">order2</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># Order 2 spectra</span>

<span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">150</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">-</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># Baseline ints</span>

<span class="c1"># Normalize the extracted spectra.</span>

<span class="n">order1_norm</span> <span class="o">=</span> <span class="n">order1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">order1</span><span class="p">[</span><span class="n">base</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">order2_norm</span> <span class="o">=</span> <span class="n">order2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">order2</span><span class="p">[</span><span class="n">base</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exotedrf.plotting</span> <span class="kn">import</span> <span class="n">make_2d_lightcurve_plot</span>

<span class="c1"># For order 2, only the wavelengths from 0.6 -- 0.85µm are useable.</span>

<span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wave2</span> <span class="o">&gt;=</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave2</span> <span class="o">&lt;</span> <span class="mf">0.85</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Display the light curves.</span>

<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vmin&#39;</span><span class="p">:</span> <span class="mf">0.9725</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">:</span> <span class="mf">1.01</span><span class="p">}</span>
<span class="n">make_2d_lightcurve_plot</span><span class="p">(</span><span class="n">wave1</span><span class="p">,</span> <span class="n">order1_norm</span><span class="p">,</span> <span class="n">wave2</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">order2_norm</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/content_notebooks_tutorial_niriss-soss_104_0.png" src="../../_images/content_notebooks_tutorial_niriss-soss_104_0.png" />
</div>
</div>
<p>Look at how clean those are!</p>
<p>If you look closely, you can notice the blues are darker, that is the transits are deeper, around 1.2, 1.4, and 1.8µm. Those are prominant water absorption bands; you can literally see the water absorption in the light curves! This is transit spectroscopy, <em>by eye!!</em> How cool is that?</p>
<p>exoTEDRF Stages 1 to 3 can also be run in script form via the provided run_DMS.py file. Simply fill out the corresponding yaml file with all relevant inputs, and you’re good to go! Generally, I like to take a first pass at the data in a notebook, where I can double check the outputs of each step, and perhaps dig a bit deeper into some interesting things that pop up. I’ll then use the script for the second pass.</p>
<p>You’re now ready to fit some light curves and get your atmosphere spectrum, which is what you really want in the end, isn’t it?!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../usage.html" class="btn btn-neutral float-left" title="exoTEDRF Usage Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tutorial_light-curve-fitting.html" class="btn btn-neutral float-right" title="Light Curve Fitting with exoTEDRF" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Michael Radica.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>